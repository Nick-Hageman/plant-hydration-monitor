<!DOCTYPE html>
<html>
  <head>
    <!--DELETE-->
    <link rel="stylesheet" type="text/css" href="css/plant_saturation.css">
    <!--Script to Graph Data below-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});

      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Hour', 'Moisture'],
          ['0',  45],
          ['1',  60],
          ['2',  30],
          ['3',  60],
          ['4',  60],
          ['5',  45],
          ['7',  43],
          ['8',  34],
          ['9',  49],
          ['10',  53],
          ['11',  47],
          ['12',  40]
        ]);

        var options = {
          title: 'Plant Saturation',
          hAxis: {title: 'Hour',  titleTextStyle: {color: 'black'}},
          vAxis: {minValue: 0},
          backgroundColor: '#353535'
        };

        var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }
      </script>
  </head>
  <body>
    <header>
      <h1 style="font-size: 40px"><img src="img/BNlogo2.png" style="vertical-align:middle" height="174.91304px" width="250px"><font color="white"> Bio::Neos Plant Monitor</font></h1>
    </header>
    <main>
      <h2>Add Plant</h2>
      <div>
        <form>
          <label>Name: <input type="text" id="name" placeholder="Insert Plant Name.."></label>
          <label>Location: <input type="text" id="location" placeholder="Insert Location.."></label>
          <label>ID: <input type="text" id="id" placeholder="Enter ID.."></label>
          <label for="file-select">Upload Image:</label>
          <input type="file" name="upload" id="file-select">
          <input type="button" value="Submit" id="btn">
        </form>
      </div>
      <div id="div-container" class="container">
        <!--COMMENT OUT (This is for testing HTML)>
        <div class="plant-list">
          <div class="card">
            <img src="img/plant1.jpg" style="vertical-align:middle" height="300px" width="250px">
            <div class="plant-details">
              <div class="name">Name: </div>
              <div class="location">Location: </div>
              <div class="id">ID: </div>
              <div class="moisture">Moisture: </div>
            </div>
            <div class="skill">
              <div class="outer">
                <div class="inner">
                  <div id="number">
                    
                  </div>
                </div>
              </div>

              <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="160px" height="160px">
                <defs>
                   <linearGradient id="GradientColor">
                      <stop offset="0%" stop-color="#e91e63" />
                      <stop offset="100%" stop-color="#673ab7" />
                   </linearGradient>
                </defs>
                <circle cx="80" cy="80" r="70" stroke-linecap="round" />
        </svg>
            </div>
            <div class="div-remove-card">
              <button class="remove-card">X</button>
            </div>
          </div>
        </div>
      <-->
      </div>
    </main>
    <!--COMMENT OUT>
    <script>
      //Script for hydration bar
      let number = document.getElementById("number");
      let counter = 0;
      setInterval(() => {
        if(counter == 65){
          clearInterval();
        }else{
          counter += 1;
          number.innerHTML = counter + "%"
        }
      }, 30);
    </script>
    <-->
    <script src="js/buttons.js"></script>
    <script src="js/fetch.js"></script>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/rainbowvis.js"></script>
    <script src="js/plant_saturation.js"></script>
    <script type="module">
      //Import
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js";
      import { getDatabase, set, ref, push, child, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-database.js";
      
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyAmMUMHrJcsD8WPnLLS4SF32Fdks5o_BgI",
        authDomain: "bioneos.firebaseapp.com",
        databaseURL: "https://bioneos-default-rtdb.firebaseio.com",
        projectId: "bioneos",
        storageBucket: "bioneos.appspot.com",
        messagingSenderId: "556458129768",
        appId: "1:556458129768:web:7aad82deab5c315cab3edd"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      // Get a reference to the database service
      const database = getDatabase(app);

      btn.addEventListener("click", (e) =>{
        var name = document.getElementById('name').value;
        var location = document.getElementById('location').value;
        var id = document.getElementById('id').value;
        var img = document.getElementById('file-select').files[0].name;

        const userId = push(child(ref(database), 'plants')).key;

        set(ref(database, 'plants/' + userId), {
          id: id,
          location: location,
          name: name,
          img: img
        });
        alert("Added Plant to Database");
      });

  //MORE TESTING
  //Iterate through 
  //  - connect sensor to plants (using id input)
  //  - display on screen
//const nameRef = ref(database, 'plants/' + '-N3vinSUZGPXaZg-Spfl' + '/name');
let i = 0;
const nameRef = ref(database, 'plants/');
onValue(nameRef, (snapshot) => {
  const data = snapshot.val();
  for (let x in data) {
    console.log(x + ": " + data[x].name);
    
    //Plant Attributes
    let name =  data[x].name
    let location =  data[x].location
    let id =  x //Users need to put this in their arduino program to send the sensor readings to this specific plant
    let img =  data[x].img
    let moisture =  data[x].sensorVal

    let html = `<div class="card">
                        <img src="img/${img}" style="vertical-align:middle" height="300px" width="250px">
                        <div class="plant-details">
                            <div class="name">Name: ${name}</div>
                            <div class="location">Location: ${location}</div>
                            <div class="id">ID: ${id}</div>
                            <div class="moisture">Moisture: ${moisture}</div>
                            </div>
                        <div class="div-remove-card">
                            <button class="remove-card" id="remove-card-${i}">X</button>
                        </div>
                    </div>`;
    
    div.insertAdjacentHTML("beforeend", html);

    document.querySelector('#remove-card-' + i)
    .addEventListener('click', function(){
        let confrm = confirm('Do you really want to remove this plant from the Database?')
        let removeEl = this.parentNode.parentNode;
        if(confrm) {
            div.removeChild(removeEl);
            //Returns the id of the specific sensor to delete it from firebase
            //console.log(removeEl.children[1].children[2].textContent.split('ID: ').pop());
            let idno = removeEl.children[1].children[2].textContent.split('ID: ').pop();
            remove(ref(database, 'plants/'+idno));
        };
    })
    i++;


  }
}, {
  onlyOnce: true
});

    </script>
    <script src='js/index.js'></script>
  </body>
</html>
